<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SMART FACE ATTENDANCE SYSTEM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        font-family: Arial, sans-serif;
        background: #0f172a;
        color: white;
        text-align: center;
        margin: 0;
        padding: 20px;
    }

    h1 {
        color: #4ade80;
        margin-bottom: 5px;
    }

    #cameraBox {
        width: 70%;
        height: 300px;
        border: 3px solid #4ade80;
        border-radius: 12px;
        margin: 20px auto;
        position: relative;
    }

    video {
        width: 100%;
        height: 100%;
        border-radius: 12px;
        object-fit: cover;
    }

    canvas {
        position: absolute;
        top: 0;
        left: 0;
    }

    .container {
        display: flex;
        justify-content: space-around;
        margin-top: 30px;
        flex-wrap: wrap;
    }

    .box {
        width: 40%;
        min-width: 280px;
        background: #1e293b;
        padding: 20px;
        border-radius: 10px;
    }

    .present { color: #4ade80; font-size: 20px; font-weight: bold; }
    .pending { color: #facc15; font-size: 20px; font-weight: bold; }

    #message {
        margin-top: 15px;
        padding: 12px;
        font-size: 18px;
        border-radius: 10px;
        display: none;
    }

    .success { background: #14532d; border: 1px solid #4ade80; }
    .error   { background: #450a0a; border: 1px solid #ef4444; }

</style>
</head>

<body>

<h1>SMART FACE ATTENDANCE SYSTEM</h1>
<p>Face Recognition will automatically mark attendance for registered students.</p>

<!-- CAMERA AREA -->
<div id="cameraBox">
    <video id="video" autoplay muted></video>
    <canvas id="canvas"></canvas>
</div>

<div id="message"></div>

<div class="container">
    <div class="box">
        <div class="present">Present Students</div>
        <ul id="presentList"></ul>
    </div>

    <div class="box">
        <div class="pending">Pending Students</div>
        <ul id="pendingList"></ul>
    </div>
</div>

<p style="margin-top:40px;opacity:0.7;">Developed by <b>Keerthana</b> & <b>Hari Chandhana</b></p>

<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

<script>

// Student Data
const students = [
    { name: "Keerthana", file: "students/Keerthana.jpeg" },
    { name: "Hari Chandana", file: "students/Hari_Chandana.jpeg" },
    { name: "Vedha Sai G", file: "students/Vedha_Sai_G.jpeg" },
    { name: "Ajith Kumar", file: "students/Ajith_Kumar.jpeg" },
    { name: "Shiva Narayana", file: "students/Shiva_Narayana.jpeg" }
];

let present = [];
let pending = students.map(s => s.name);

function updateUI() {
    document.getElementById("presentList").innerHTML =
        present.map(p => `<li>${p} ✔</li>`).join("");

    document.getElementById("pendingList").innerHTML =
        pending.map(p => `<li>${p} ⏳</li>`).join("");
}

updateUI();

function showMsg(type, text) {
    let box = document.getElementById("message");
    box.style.display = "block";
    box.className = type === "success" ? "success" : "error";
    box.innerHTML = text;
}

// Load Models
Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri("models"),
    faceapi.nets.faceLandmark68Net.loadFromUri("models"),
    faceapi.nets.faceRecognitionNet.loadFromUri("models")
]).then(loadFaces);

// Load Student Images
async function loadFaces() {
    const labeled = [];

    for (let s of students) {
        const img = await faceapi.fetchImage(s.file);
        const det = await faceapi.detectSingleFace(
            img, new faceapi.TinyFaceDetectorOptions()
        ).withFaceLandmarks().withFaceDescriptor();

        labeled.push(new faceapi.LabeledFaceDescriptors(s.name, [det.descriptor]));
    }

    startCamera(labeled);
}

// Start Webcam + Recognition
async function startCamera(labeledFaces) {

    const video = document.getElementById("video");
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;

    video.onplay = () => {
        const canvas = document.getElementById("canvas");
        const displaySize = { width: video.clientWidth, height: video.clientHeight };

        canvas.width = displaySize.width;
        canvas.height = displaySize.height;

        const matcher = new faceapi.FaceMatcher(labeledFaces, 0.45);

        setInterval(async () => {

            const dets = await faceapi.detectAllFaces(
                video, new faceapi.TinyFaceDetectorOptions()
            ).withFaceLandmarks().withFaceDescriptors();

            const resized = faceapi.resizeResults(dets, displaySize);

            canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);

            resized.forEach(d => {
                const match = matcher.findBestMatch(d.descriptor).label;
                const box = d.detection.box;

                let ctx = canvas.getContext("2d");
                ctx.strokeStyle = "#4ade80";
                ctx.lineWidth = 2;
                ctx.strokeRect(box.x, box.y, box.width, box.height);

                ctx.fillStyle = "#4ade80";
                ctx.fillText(match, box.x, box.y - 5);

                if (match !== "unknown" && pending.includes(match)) {
                    present.push(match);
                    pending = pending.filter(n => n !== match);
                    updateUI();
                    showMsg("success", `✔ Attendance taken for <b>${match}</b>`);
                }
            });

        }, 300);
    };
}

</script>

</body>
</html>
